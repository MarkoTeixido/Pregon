name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # Job 1: Esperar a que pasen los tests
  wait-for-tests:
    runs-on: ubuntu-latest
    steps:
    - name: ‚è≥ Esperar a que pasen los tests
      uses: lewagon/wait-on-check-action@v1.3.1
      with:
        ref: ${{ github.ref }}
        check-name: 'test'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        wait-interval: 10

  # Job 2: Deploy a Railway
  deploy-railway:
    needs: wait-for-tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: üöÇ Install Railway CLI
      run: npm i -g @railway/cli
    
    - name: üöÄ Deploy Discord Bot
      run: railway up --service discord-bot
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    - name: üöÄ Deploy WhatsApp Webhook
      run: railway up --service whatsapp-webhook
      env:
        RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    
    - name: ‚úÖ Deployment notification
      run: |
        echo "### üöÄ Deployment Successful" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ Discord Bot deployed" >> $GITHUB_STEP_SUMMARY
        echo "‚úÖ WhatsApp Webhook deployed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üîó Railway Dashboard: https://railway.app/project/${{ secrets.RAILWAY_PROJECT_ID }}" >> $GITHUB_STEP_SUMMARY

  # Job 3: Health Check Post-Deploy
  health-check:
    needs: deploy-railway
    runs-on: ubuntu-latest
    
    steps:
    - name: üè• Health Check - WhatsApp Webhook
      run: |
        sleep 30  # Esperar a que el servicio inicie
        curl -f ${{ secrets.WHATSAPP_WEBHOOK_URL }}/health || exit 1
    
    - name: ‚úÖ Health check passed
      run: echo "‚úÖ All services are healthy"